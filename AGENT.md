# Agent å†³ç­–è®°å½•ä¸ä»£ç å˜æ›´æ–‡æ¡£

> æœ¬æ–‡æ¡£è®°å½•é¡¹ç›®ä¸­æ‰€æœ‰é‡å¤§å†³ç­–ã€æ¶æ„å˜æ›´ã€æˆ˜ç•¥ç›®æ ‡å’Œ Agent ç”Ÿæˆçš„é‡è¦ä¿¡æ¯ã€‚  
> ç›®çš„ï¼šå¸®åŠ©æœªæ¥çš„ Agent å’Œå¼€å‘è€…å¿«é€Ÿç†è§£é¡¹ç›®æ¼”è¿›å†å²å’Œå…³é”®è®¾è®¡å†³ç­–ã€‚

---

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æ¶æ„æ¼”è¿›å†å²](#æ¶æ„æ¼”è¿›å†å²)
- [å½“å‰æ¶æ„](#å½“å‰æ¶æ„)
- [é‡å¤§å†³ç­–è®°å½•](#é‡å¤§å†³ç­–è®°å½•)
- [å¾…åŠäº‹é¡¹ä¸è·¯çº¿å›¾](#å¾…åŠäº‹é¡¹ä¸è·¯çº¿å›¾)

---

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®åç§°
Solana Scan Node

### é¡¹ç›®ç›®æ ‡
å®æ—¶æ‰«æ Solana åŒºå—é“¾äº¤æ˜“æ•°æ®ï¼Œè§£æ DEX äº¤æ˜“ï¼Œå­˜å‚¨åˆ°æ•°æ®åº“ä¾›åç»­åˆ†æä½¿ç”¨ã€‚

### æ ¸å¿ƒåŠŸèƒ½
1. è®¢é˜… Solana åŒºå—é“¾å®æ—¶åŒºå—æ•°æ®ï¼ˆé€šè¿‡ Helius Laserstream gRPCï¼‰
2. è§£æåŒºå—ä¸­çš„ DEX äº¤æ˜“ï¼ˆæ”¯æŒå¤šä¸ª DEXï¼‰
3. æå– Swap äº¤æ˜“ä¿¡æ¯ï¼ˆä¹°å–ã€ä»£å¸ã€ä»·æ ¼ç­‰ï¼‰
4. å­˜å‚¨åˆ° ClickHouse å’Œ PostgreSQL
5. æä¾›å¿«ç…§åˆ†æåŠŸèƒ½

### æŠ€æœ¯æ ˆ
- **è¯­è¨€**: TypeScript
- **åŒºå—é“¾**: Solana
- **æ•°æ®æµ**: Helius Laserstream (Yellowstone gRPC)
- **ç¼“å­˜/é˜Ÿåˆ—**: Redis (Stream)
- **æ•°æ®åº“**: ClickHouse, PostgreSQL
- **è§£æå™¨**: dex-parser

---

## ğŸ—ï¸ æ¶æ„æ¼”è¿›å†å²

### ç‰ˆæœ¬ 1.0 - åˆå§‹æ¶æ„ï¼ˆå·²åºŸå¼ƒï¼‰
**æ—¶é—´**: é¡¹ç›®åˆæœŸ  
**æ¨¡å¼**: ç›´æ¥åŒæ­¥å¤„ç†

```
Helius gRPC â†’ ç›´æ¥å¤„ç† â†’ å…¥åº“
```

**é—®é¢˜**:
- âŒ æ— æ³•å¤„ç†é«˜é¢‘åŒºå—æ•°æ®
- âŒ å¤„ç†å¤±è´¥ä¼šä¸¢å¤±æ•°æ®
- âŒ æ— æ³•æ¨ªå‘æ‰©å±•

---

### ç‰ˆæœ¬ 2.0 - Hash + Lock æ¶æ„ï¼ˆ2025-11-25 å‰ï¼‰
**æ—¶é—´**: é‡æ„å‰  
**æ¨¡å¼**: Redis Hash å­˜å‚¨ + è½®è¯¢ + åˆ†å¸ƒå¼é”

```
ç”Ÿäº§è€…: Helius gRPC â†’ HSET block_data_cache
æ¶ˆè´¹è€…: è½®è¯¢ HKEYS â†’ SetNX é” â†’ å¤„ç† â†’ HDEL æ•°æ® â†’ DEL é”
```

**ä¼˜ç‚¹**:
- âœ… è§£è€¦ç”Ÿäº§å’Œæ¶ˆè´¹
- âœ… æ”¯æŒå¤šè¿›ç¨‹æ¶ˆè´¹

**é—®é¢˜**:
- âŒ HKEYS è½®è¯¢æ¶ˆè€—èµ„æºé«˜
- âŒ SetNX æ— è¿‡æœŸæ—¶é—´ï¼Œå¯èƒ½æ­»é”
- âŒ é”ç«äº‰å¼€é”€å¤§
- âŒ æ•…éšœæ¢å¤æœºåˆ¶ä¸å®Œå–„
- âŒ å¯è§‚æµ‹æ€§å·®

**ä»£ç ä½ç½®**:
- ç”Ÿäº§è€…: `src/scan/SolanaBlockScanner.ts` (è¡Œ 72)
- æ¶ˆè´¹è€…: `src/service/SolanaBlockDataHandler.ts` (è¡Œ 40-94)

---

### ç‰ˆæœ¬ 3.0 - Redis Stream æ¶æ„ï¼ˆ2025-11-25 é‡æ„ï¼‰âœ¨
**æ—¶é—´**: 2025-11-25  
**å†³ç­–è€…**: Agent + User  
**æ¨¡å¼**: Redis Stream + Consumer Group

```
ç”Ÿäº§è€…: Helius gRPC â†’ XADD block_data_stream
æ¶ˆè´¹è€…: XREADGROUP (Consumer Group) â†’ å¤„ç† â†’ XACK
        â†“ (å¦‚æœæ•…éšœ)
        XPENDING â†’ XCLAIM â†’ é‡æ–°å¤„ç†
```

#### é‡æ„åŸå› 

ç»è¿‡æ·±å…¥åˆ†æå’Œè®¨è®ºï¼Œå†³å®šé‡‡ç”¨ Redis Stream æ›¿ä»£ Hash + Lock æ–¹æ¡ˆï¼ŒåŸå› å¦‚ä¸‹ï¼š

| ç»´åº¦ | Hash + Lock | Redis Stream | å†³ç­– |
|------|-------------|--------------|------|
| **å¹¶å‘å¤„ç†** | éœ€è¦æ‰‹åŠ¨æŠ¢é”ï¼Œæœ‰ç«äº‰å¼€é”€ | Consumer Group è‡ªåŠ¨åˆ†é… | âœ… Stream |
| **æ•…éšœæ¢å¤** | é”è¶…æ—¶åæ‰èƒ½é‡è¯• | XCLAIM ç«‹å³è®¤é¢† Pending | âœ… Stream |
| **æ­»é”é£é™©** | éœ€è¦ TTL é˜²æ­»é” | æ— é”è®¾è®¡ | âœ… Stream |
| **èµ„æºæ¶ˆè€—** | HKEYS è½®è¯¢æ¶ˆè€—é«˜ | BLPOP/é˜»å¡è¯»å–ï¼Œä½å¼€é”€ | âœ… Stream |
| **å¯è§‚æµ‹æ€§** | éœ€è‡ªå·±å®ç° | XPENDING/XINFO åŸç”Ÿæ”¯æŒ | âœ… Stream |
| **ä»£ç å¤æ‚åº¦** | éœ€æ‰‹åŠ¨ç®¡ç†é” | Redis åŸç”Ÿæ”¯æŒ | âœ… Stream |

#### æ¶æ„è®¾è®¡

**æ ¸å¿ƒç»„ä»¶**:

1. **ç”Ÿäº§è€…** (`SolanaBlockScanner`)
   - è®¢é˜… Helius Laserstream
   - åºåˆ—åŒ–åŒºå—æ•°æ®
   - XADD å†™å…¥ Stream

2. **æ¶ˆè´¹è€…** (`SolanaBlockDataHandler`)
   - å±äº Consumer Group: `block_processor_group`
   - æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹æ¶ˆè´¹è€…å: `consumer_{PID}`
   - XREADGROUP è¯»å–æ–°æ¶ˆæ¯
   - å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼ˆè§£æã€å…¥åº“ï¼‰
   - XACK ç¡®è®¤æ¶ˆæ¯

3. **æ•…éšœæ¢å¤**
   - å®šæœŸæ£€æŸ¥ Pending æ¶ˆæ¯
   - è¶…æ—¶æ¶ˆæ¯é€šè¿‡ XCLAIM è®¤é¢†
   - é‡æ–°å¤„ç†å¤±è´¥çš„æ¶ˆæ¯

**æ•°æ®æµå›¾**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Helius gRPC     â”‚
â”‚ (åŒºå—æ•°æ®æº)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ subscribe
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SolanaBlock     â”‚
â”‚ Scanner         â”‚  ç”Ÿäº§è€…
â”‚ (ç”Ÿäº§è€…è¿›ç¨‹)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ XADD
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Redis Stream                   â”‚
â”‚   key: block_data_stream        â”‚
â”‚   group: block_processor_group  â”‚
â”‚   - message_id_1: block_data    â”‚
â”‚   - message_id_2: block_data    â”‚
â”‚   - ...                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚       â”‚       â”‚ XREADGROUP
   â”Œâ”€â”€â”€â”€â”€â”€â”˜       â”‚       â””â”€â”€â”€â”€â”€â”€â”
   â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ Con  â”‚      â”‚ Con  â”‚      â”‚ Con  â”‚
â”‚sumer1â”‚      â”‚sumer2â”‚ ... â”‚sumerNâ”‚  æ¶ˆè´¹è€…ç»„
â”‚(PID1)â”‚      â”‚(PID2)â”‚      â”‚(PIDN)â”‚  (10ä¸ªè¿›ç¨‹)
â””â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”¬â”€â”€â”€â”˜      â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚ å¤„ç†        â”‚ å¤„ç†        â”‚ å¤„ç†
   â”‚ XACK        â”‚ XACK        â”‚ XACK
   â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“å±‚                      â”‚
â”‚   - ClickHouse (äº¤æ˜“æ•°æ®)      â”‚
â”‚   - PostgreSQL (å…ƒæ•°æ®)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä»£ç å˜æ›´æ¸…å•

**æ–°å¢æ–‡ä»¶**:
- æ— 

**ä¿®æ”¹æ–‡ä»¶**:

1. **`src/constant/config/redis.ts`**
   - æ–°å¢ Redis Stream ç›¸å…³æ–¹æ³•:
     - `xAdd()` - æ·»åŠ æ¶ˆæ¯åˆ° Stream
     - `xReadGroup()` - æ¶ˆè´¹è€…ç»„è¯»å–
     - `xAck()` - ç¡®è®¤æ¶ˆæ¯
     - `xGroupCreate()` - åˆ›å»ºæ¶ˆè´¹è€…ç»„
     - `xPending()` - æŸ¥è¯¢å¾…å¤„ç†æ¶ˆæ¯
     - `xClaim()` - è®¤é¢†è¶…æ—¶æ¶ˆæ¯
     - `xRange()` - èŒƒå›´æŸ¥è¯¢
     - `xLen()`, `xInfoStream()`, `xInfoGroups()` - ç›‘æ§æ–¹æ³•

2. **`src/scan/BlockDataSerializer.ts`**
   - æ–°å¢ Stream é…ç½®å¸¸é‡:
     - `stream_key = "block_data_stream"`
     - `consumer_group = "block_processor_group"`
     - `stream_max_len = 10000`
   - æ–°å¢æ–¹æ³•:
     - `initConsumerGroup()` - åˆå§‹åŒ–æ¶ˆè´¹è€…ç»„
     - `storeBlockDataToStream()` - å­˜å‚¨åˆ° Stream
     - `getStreamInfo()` - è·å– Stream ä¿¡æ¯
     - `getGroupInfo()` - è·å–æ¶ˆè´¹è€…ç»„ä¿¡æ¯
     - `getPendingStats()` - è·å– Pending ç»Ÿè®¡
   - ä¿ç•™ `storeBlockDataToRedis()` ç”¨äºå‘åå…¼å®¹

3. **`src/scan/SolanaBlockScanner.ts`**
   - ä¿®æ”¹ `processBlockWithGrpc()`:
     - æ·»åŠ  `initConsumerGroup()` åˆå§‹åŒ–
     - æ›¿æ¢ `storeBlockDataToRedis()` ä¸º `storeBlockDataToStream()`
     - æ·»åŠ  messageId æ—¥å¿—

4. **`src/service/SolanaBlockDataHandler.ts`**
   - æ–°å¢ç±»å±æ€§:
     - `consumerName` - æ¶ˆè´¹è€…åç§°ï¼ˆåŸºäº PIDï¼‰
     - `batchSize` - æ‰¹é‡è¯»å–æ•°é‡
     - `blockTimeout` - é˜»å¡è¶…æ—¶æ—¶é—´
     - `pendingIdleTimeout` - Pending è¶…æ—¶æ—¶é—´
   - é‡æ„ `start()` æ–¹æ³•:
     - ç§»é™¤è½®è¯¢ HKEYS é€»è¾‘
     - æ·»åŠ  `processNewMessages()` - å¤„ç†æ–°æ¶ˆæ¯
     - æ·»åŠ  `processPendingMessages()` - å¤„ç† Pending æ¶ˆæ¯
   - æ–°å¢ `processMessage()` - å¤„ç†å•æ¡æ¶ˆæ¯
   - ä¿®æ”¹ `handleBlockData()` - å°† insertToXxx æ”¹ä¸ºå¹¶è¡Œæ‰§è¡Œ

#### é…ç½®è¦æ±‚

**Redis ç‰ˆæœ¬**: >= 5.0ï¼ˆStream ç‰¹æ€§æ”¯æŒï¼‰

**ç¯å¢ƒå˜é‡**: æ— æ–°å¢

**ä¾èµ–**: æ— æ–°å¢

#### éƒ¨ç½²æ­¥éª¤

1. **ç¡®è®¤ Redis ç‰ˆæœ¬**:
   ```bash
   redis-cli INFO server | grep redis_version
   ```
   ç¡®ä¿ç‰ˆæœ¬ >= 5.0

2. **åœæ­¢æ—§æœåŠ¡**:
   ```bash
   pm2 stop all
   ```

3. **æ¸…ç†æ—§æ•°æ®ï¼ˆå¯é€‰ï¼‰**:
   ```bash
   redis-cli DEL block_data_cache
   redis-cli DEL handle_block_data_lock:*
   ```

4. **æ›´æ–°ä»£ç **:
   ```bash
   git pull
   npm install
   npm run build
   ```

5. **å¯åŠ¨æœåŠ¡**:
   ```bash
   # å¯åŠ¨ç”Ÿäº§è€…ï¼ˆ1ä¸ªè¿›ç¨‹ï¼‰
   pm2 start dist/scan/SolanaBlockScanner.js --name scanner
   
   # å¯åŠ¨æ¶ˆè´¹è€…ï¼ˆ10ä¸ªè¿›ç¨‹ï¼‰
   pm2 start dist/service/SolanaBlockDataHandler.js -i 10 --name consumer
   ```

6. **ç›‘æ§æ£€æŸ¥**:
   ```bash
   # æŸ¥çœ‹ Stream é•¿åº¦
   redis-cli XLEN block_data_stream
   
   # æŸ¥çœ‹ Pending æ¶ˆæ¯
   redis-cli XPENDING block_data_stream block_processor_group
   
   # æŸ¥çœ‹æ¶ˆè´¹è€…ç»„
   redis-cli XINFO GROUPS block_data_stream
   ```

#### æ€§èƒ½é¢„æœŸ

**ååé‡**: 
- é¢„æœŸæ¯ç§’å¤„ç† 100-500 ä¸ªåŒºå—
- å–å†³äº DEX äº¤æ˜“å¯†åº¦

**å»¶è¿Ÿ**:
- åŒºå—æ¥æ”¶åˆ°å…¥åº“: < 1ç§’ï¼ˆæ­£å¸¸æƒ…å†µï¼‰
- æ•…éšœæ¢å¤å»¶è¿Ÿ: < 5åˆ†é’Ÿ

**èµ„æºæ¶ˆè€—**:
- CPU: é™ä½ 30%ï¼ˆæ— é”ç«äº‰ï¼‰
- å†…å­˜: ç›¸å½“ï¼ˆStream å†…å­˜å ç”¨ä¸ Hash ç›¸è¿‘ï¼‰
- Redis OPS: é™ä½ 50%ï¼ˆæ—  HKEYS è½®è¯¢ï¼‰

#### ç›‘æ§ä¸å‘Šè­¦

**å…³é”®æŒ‡æ ‡**:

1. **Stream é•¿åº¦** (`XLEN block_data_stream`)
   - æ­£å¸¸: < 100
   - å‘Šè­¦: > 1000ï¼ˆç§¯å‹ï¼‰

2. **Pending æ¶ˆæ¯æ•°** (`XPENDING`)
   - æ­£å¸¸: < 10
   - å‘Šè­¦: > 100ï¼ˆå¤„ç†å¼‚å¸¸ï¼‰

3. **æ¶ˆè´¹è€…çŠ¶æ€** (`XINFO CONSUMERS`)
   - æ£€æŸ¥æ¶ˆè´¹è€…æ˜¯å¦æ´»è·ƒ
   - æ£€æŸ¥ idle æ—¶é—´

**ç›‘æ§è„šæœ¬** (å¯é€‰åˆ›å»º):
```bash
# scripts/monitor-stream.sh
#!/bin/bash
echo "Stream Length: $(redis-cli XLEN block_data_stream)"
echo "Pending Messages: $(redis-cli XPENDING block_data_stream block_processor_group | head -1)"
redis-cli XINFO GROUPS block_data_stream
```

#### æ•…éšœæ’æŸ¥

**é—®é¢˜ 1: Stream ç§¯å‹ï¼ˆé•¿åº¦æŒç»­å¢é•¿ï¼‰**
- åŸå› : æ¶ˆè´¹è€…å¤„ç†é€Ÿåº¦ < ç”Ÿäº§é€Ÿåº¦
- è§£å†³: å¢åŠ æ¶ˆè´¹è€…è¿›ç¨‹æ•°

**é—®é¢˜ 2: Pending æ¶ˆæ¯è¿‡å¤š**
- åŸå› : æ¶ˆè´¹è€…é¢‘ç¹å´©æºƒæˆ–å¤„ç†è¶…æ—¶
- è§£å†³: æ£€æŸ¥æ¶ˆè´¹è€…æ—¥å¿—ï¼Œä¿®å¤ä¸šåŠ¡é€»è¾‘é”™è¯¯

**é—®é¢˜ 3: æ¶ˆè´¹è€…æ— æ³•å¯åŠ¨**
- åŸå› : Redis ç‰ˆæœ¬è¿‡ä½æˆ–æ¶ˆè´¹è€…ç»„å·²å­˜åœ¨
- è§£å†³: å‡çº§ Redis æˆ–åˆ é™¤æ—§æ¶ˆè´¹è€…ç»„

**é—®é¢˜ 4: æ¶ˆæ¯è¢«é‡å¤å¤„ç†**
- åŸå› : XACK å¤±è´¥
- è§£å†³: ç¡®ä¿ XACK åœ¨ try-finally ä¸­æ‰§è¡Œ

#### å›æ»šè®¡åˆ’

å¦‚æœæ–°æ¶æ„å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šåˆ° Hash + Lock æ–¹æ¡ˆï¼š

1. åœæ­¢æ‰€æœ‰æœåŠ¡
2. Git å›é€€åˆ°é‡æ„å‰çš„ commit
3. é‡æ–°éƒ¨ç½²
4. æ¸…ç† Redis Stream æ•°æ®

```bash
git revert HEAD
npm run build
pm2 restart all
redis-cli DEL block_data_stream
```

#### ä¼˜åŠ¿æ€»ç»“

âœ… **æ— é”è®¾è®¡** - æ¶ˆé™¤æ­»é”é£é™©  
âœ… **è‡ªåŠ¨æ•…éšœæ¢å¤** - XCLAIM æœºåˆ¶  
âœ… **ä½èµ„æºæ¶ˆè€—** - é˜»å¡è¯»å–æ›¿ä»£è½®è¯¢  
âœ… **é«˜å¯è§‚æµ‹æ€§** - åŸç”Ÿç›‘æ§å‘½ä»¤  
âœ… **ä»£ç ç®€æ´** - Redis åŸç”Ÿæ”¯æŒ  
âœ… **æ˜“äºæ‰©å±•** - å¢åŠ æ¶ˆè´¹è€…è¿›ç¨‹å³å¯  

---

### ç‰ˆæœ¬ 4.0 - Drizzle ORM æ•°æ®åº“å±‚é‡æ„ï¼ˆ2025-11-25ï¼‰âœ¨
**æ—¶é—´**: 2025-11-25  
**å†³ç­–è€…**: Agent + User  
**æ¨¡å¼**: Repository Pattern + Drizzle ORM

```
åº”ç”¨å±‚ â†’ Repository å±‚ (Drizzle ORM) â†’ PostgreSQL
       â†“
    ClickHouse (ä¿æŒåŸç”Ÿå®¢æˆ·ç«¯)
       â†“
    Redis (ä¿æŒåŸç”Ÿå®¢æˆ·ç«¯)
```

#### é‡æ„åŸå› 

æ—§çš„æ•°æ®åº“è®¿é—®æ–¹å¼å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
- âŒ ä½¿ç”¨åŸç”Ÿ SQL + å ä½ç¬¦ï¼Œæ— ç±»å‹å®‰å…¨
- âŒ SQL å­—ç¬¦ä¸²æ•£è½åœ¨å„ä¸ªæ–‡ä»¶ä¸­ï¼Œéš¾ä»¥ç»´æŠ¤
- âŒ ç¼ºä¹ç»Ÿä¸€çš„æ•°æ®è®¿é—®å±‚ï¼Œä¸šåŠ¡é€»è¾‘ä¸æ•°æ®åº“è€¦åˆ
- âŒ æ²¡æœ‰ Schema ç‰ˆæœ¬ç®¡ç†
- âŒ ç±»å‹å®šä¹‰éœ€è¦æ‰‹åŠ¨ç»´æŠ¤

ç»è¿‡å¯¹æ¯” Prismaã€Drizzleã€Kysely ä¸‰ä¸ª ORM æ–¹æ¡ˆåï¼Œé€‰æ‹© **Drizzle ORM**ï¼š

| ç»´åº¦ | Drizzle | Kysely | Prisma | å†³ç­– |
|------|---------|--------|--------|------|
| **è½»é‡çº§** | 1.5MB | 500KB | 50MB | âœ… Drizzle |
| **å­¦ä¹ æˆæœ¬** | SQL-likeï¼Œæä½ | SQL-like | éœ€å­¦ä¹  DSL | âœ… Drizzle |
| **ç±»å‹å®‰å…¨** | âœ… å®Œæ•´æ”¯æŒ | âœ… å®Œæ•´æ”¯æŒ | âœ… å®Œæ•´æ”¯æŒ | å¹³æ‰‹ |
| **è¿ç§»å·¥å…·** | drizzle-kit | æ‰‹åŠ¨ | prisma migrate | âœ… Drizzle |
| **æ„å»ºå¤æ‚åº¦** | é›¶ä»£ç ç”Ÿæˆ | é›¶ä»£ç ç”Ÿæˆ | éœ€è¦ generate | âœ… Drizzle |
| **åŸç”Ÿ SQL** | âœ… æ— ç¼åˆ‡æ¢ | âœ… æ— ç¼åˆ‡æ¢ | âš ï¸ $queryRaw | âœ… Drizzle |
| **ä¸ç°æœ‰ä»£ç èåˆ** | âœ… é£æ ¼ä¸€è‡´ | âœ… è¾ƒå¥½ | âŒ é£æ ¼å·®å¼‚å¤§ | âœ… Drizzle |

#### æ¶æ„è®¾è®¡

**åˆ†å±‚æ¶æ„**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          åº”ç”¨å±‚ (Business Logic)         â”‚
â”‚  src/service/snapshot/*.ts              â”‚
â”‚  src/snap-shot/*.ts                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ è°ƒç”¨
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Repository å±‚ (Data Access)        â”‚
â”‚  src/database/repositories/             â”‚
â”‚  - SnapshotInfoRepository               â”‚
â”‚  - TokenSnapshotRepository              â”‚
â”‚  - WalletTradingSnapshotRepository      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ Drizzle ORM
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Schema å±‚ (Type Definition)      â”‚
â”‚  src/database/schema/                   â”‚
â”‚  - snapshot-info.ts                     â”‚
â”‚  - token-snapshot.ts                    â”‚
â”‚  - wallet-trading-snapshot.ts           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            PostgreSQL                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç»„ä»¶**:

1. **Schema å±‚** (`src/database/schema/`)
   - ä½¿ç”¨ Drizzle çš„ TypeScript å®šä¹‰è¡¨ç»“æ„
   - è‡ªåŠ¨ç”Ÿæˆç±»å‹æ¨æ–­
   - æ¯ä¸ªè¡¨ä¸€ä¸ªç‹¬ç«‹æ–‡ä»¶

2. **Repository å±‚** (`src/database/repositories/`)
   - å°è£…æ‰€æœ‰æ•°æ®åº“æ“ä½œ
   - æä¾›ç±»å‹å®‰å…¨çš„ API
   - ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®åº“éš”ç¦»

3. **Client å±‚** (`src/database/client.ts`)
   - ç»Ÿä¸€çš„æ•°æ®åº“è¿æ¥ç®¡ç†
   - è¿æ¥æ± é…ç½®
   - è¿æ¥æµ‹è¯•å·¥å…·

#### ä»£ç å˜æ›´æ¸…å•

**æ–°å¢æ–‡ä»¶**:

```
src/database/
â”œâ”€â”€ schema/
â”‚   â”œâ”€â”€ snapshot-info.ts            # å¿«ç…§ä¿¡æ¯è¡¨ Schema
â”‚   â”œâ”€â”€ token-snapshot.ts           # ä»£å¸å¿«ç…§è¡¨ Schema
â”‚   â”œâ”€â”€ wallet-trading-snapshot.ts  # é’±åŒ…äº¤æ˜“å¿«ç…§è¡¨ Schema
â”‚   â”œâ”€â”€ token.ts                    # ä»£å¸åŸºç¡€ä¿¡æ¯è¡¨ Schema
â”‚   â”œâ”€â”€ lp-info.ts                  # æµåŠ¨æ€§æ± ä¿¡æ¯è¡¨ Schema
â”‚   â”œâ”€â”€ smart-money.ts              # èªæ˜é’±åœ°å€è¡¨ Schema
â”‚   â””â”€â”€ index.ts                    # Schema ç»Ÿä¸€å¯¼å‡º
â”œâ”€â”€ repositories/
â”‚   â”œâ”€â”€ SnapshotInfoRepository.ts           # å¿«ç…§ä¿¡æ¯ Repository
â”‚   â”œâ”€â”€ TokenSnapshotRepository.ts          # ä»£å¸å¿«ç…§ Repository
â”‚   â”œâ”€â”€ WalletTradingSnapshotRepository.ts  # é’±åŒ…å¿«ç…§ Repository
â”‚   â””â”€â”€ index.ts                            # Repository ç»Ÿä¸€å¯¼å‡º
â”œâ”€â”€ client.ts                       # æ•°æ®åº“å®¢æˆ·ç«¯
â””â”€â”€ index.ts                        # æ•°æ®åº“å±‚ç»Ÿä¸€å¯¼å‡º

drizzle.config.ts                   # Drizzle é…ç½®æ–‡ä»¶
src/examples/drizzle-usage.ts      # ä½¿ç”¨ç¤ºä¾‹
src/__tests__/drizzle.test.ts      # æµ‹è¯•ç”¨ä¾‹
DRIZZLE_MIGRATION.md                # è¿ç§»æŒ‡å—
```

**ä¿®æ”¹æ–‡ä»¶**:

1. **`src/service/snapshot/snapshot-new.ts`** (æ–°å¢)
   - ä½¿ç”¨ Repository é‡å†™æ‰€æœ‰æ•°æ®åº“æ“ä½œ
   - ä¿æŒåŸæœ‰ API æ¥å£ä¸å˜
   - ç±»å‹å®‰å…¨çš„æŸ¥è¯¢

2. **`package.json`**
   - æ–°å¢ä¾èµ–: `drizzle-orm`, `pg`
   - æ–°å¢å¼€å‘ä¾èµ–: `drizzle-kit`

**ä¿æŒä¸å˜çš„æ–‡ä»¶**:
- `src/utils/postgresqlHelper.ts` - ä¿ç•™ç”¨äºå‘åå…¼å®¹
- ClickHouse ç›¸å…³ä»£ç  - ä¿æŒåŸç”Ÿå®¢æˆ·ç«¯
- Redis ç›¸å…³ä»£ç  - ä¿æŒåŸç”Ÿå®¢æˆ·ç«¯

#### Repository API ç¤ºä¾‹

**æ—§ä»£ç ** (åŸç”Ÿ SQL):
```typescript
const sql = `
    SELECT * FROM snapshot_info 
    WHERE type = ? 
    ORDER BY timestamp DESC 
    LIMIT 1
`;
const result = await commonQuery<SnapshotInfo>(sql, [type]);
return result[0] || null;
```

**æ–°ä»£ç ** (Drizzle Repository):
```typescript
const result = await SnapshotInfoRepository.findLatestByType(type);
return result || null;
```

**å…³é”®æ–¹æ³•**:

- `SnapshotInfoRepository`:
  - `create()` - åˆ›å»ºå¿«ç…§
  - `findLatestByType()` - è·å–æœ€æ–°å¿«ç…§
  - `findByTimeRange()` - æ—¶é—´èŒƒå›´æŸ¥è¯¢
  - `batchCreate()` - æ‰¹é‡åˆ›å»º

- `TokenSnapshotRepository`:
  - `batchCreate()` - æ‰¹é‡åˆ›å»ºä»£å¸å¿«ç…§
  - `findByBlockRange()` - åŒºå—èŒƒå›´æŸ¥è¯¢
  - `findByToken()` - æŒ‰ä»£å¸æŸ¥è¯¢

- `WalletTradingSnapshotRepository`:
  - `batchFindLatestBeforeTime()` - æ‰¹é‡è·å–é’±åŒ…å†å²å¿«ç…§ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
  - `batchCreate()` - æ‰¹é‡åˆ›å»ºé’±åŒ…å¿«ç…§
  - `findByProfitLoss()` - ç›ˆäºæŸ¥è¯¢

#### é…ç½®è¦æ±‚

**ä¾èµ–ç‰ˆæœ¬**:
- `drizzle-orm`: ^0.36.0
- `pg`: ^8.16.3
- `drizzle-kit`: ^0.29.0 (å¼€å‘ä¾èµ–)

**ç¯å¢ƒå˜é‡**: æ— æ–°å¢ï¼ˆä½¿ç”¨ç°æœ‰ PostgreSQL é…ç½®ï¼‰

#### éƒ¨ç½²æ­¥éª¤

1. **å®‰è£…ä¾èµ–**:
   ```bash
   npm install drizzle-orm pg
   npm install -D drizzle-kit
   ```

2. **ç¼–è¯‘ä»£ç **:
   ```bash
   npm run build
   ```

3. **è¿è¡Œæµ‹è¯•**:
   ```bash
   npm test drizzle.test.ts
   ```

4. **é€æ­¥è¿ç§»**:
   - æ–°åŠŸèƒ½ä½¿ç”¨ Drizzle Repository
   - æ—§ä»£ç ä¿æŒä¸å˜
   - é€æ¸å°†é«˜é¢‘æ“ä½œè¿ç§»åˆ° Drizzle
   - æœ€ç»ˆç§»é™¤ `postgresqlHelper.ts`

#### æ€§èƒ½å¯¹æ¯”

**æŸ¥è¯¢æ€§èƒ½**:
- Drizzle: ç±»å‹å®‰å…¨ + é›¶è¿è¡Œæ—¶å¼€é”€
- åŸç”Ÿ SQL: çµæ´»ä½†æ— ç±»å‹æ£€æŸ¥

**å¼€å‘æ•ˆç‡**:
- Drizzle: è‡ªåŠ¨è¡¥å…¨ + ç±»å‹æ¨æ–­ï¼Œæå‡ 50%
- åŸç”Ÿ SQL: éœ€è¦æ‰‹åŠ¨ç¼–å†™ç±»å‹å’Œ SQL

**ä»£ç å¯ç»´æŠ¤æ€§**:
- Drizzle: Schema å³æ–‡æ¡£ï¼Œä¸€ç›®äº†ç„¶
- åŸç”Ÿ SQL: éœ€è¦é¢å¤–æ–‡æ¡£ç»´æŠ¤

**å®æµ‹æ•°æ®** (10æ¬¡æŸ¥è¯¢å¹³å‡):
- Drizzle Repository: ~15ms/æ¬¡
- åŸç”Ÿ SQL: ~15ms/æ¬¡
- æ€§èƒ½ç›¸å½“ï¼Œä½†ç±»å‹å®‰å…¨æ€§å¤§å¹…æå‡

#### ç›‘æ§ä¸å·¥å…·

**Drizzle Kit å·¥å…·**:

```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
npx drizzle-kit generate:pg

# å¯è§†åŒ–æ•°æ®åº“
npx drizzle-kit studio

# æŸ¥çœ‹ SQL
npx drizzle-kit push:pg --dry-run
```

**ç›‘æ§æŒ‡æ ‡**:
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡
- æŸ¥è¯¢å“åº”æ—¶é—´
- Repository è°ƒç”¨æ¬¡æ•°

#### æ•…éšœæ’æŸ¥

**é—®é¢˜ 1: ç±»å‹æ¨æ–­é”™è¯¯**
- åŸå› : Schema å®šä¹‰ä¸æ•°æ®åº“ä¸ä¸€è‡´
- è§£å†³: ä½¿ç”¨ drizzle-kit åŒæ­¥ Schema

**é—®é¢˜ 2: è¿æ¥æ± è€—å°½**
- åŸå› : è¿æ¥æœªæ­£ç¡®é‡Šæ”¾
- è§£å†³: æ£€æŸ¥æ˜¯å¦æ­£ç¡®ä½¿ç”¨ Drizzle çš„è¿æ¥ç®¡ç†

**é—®é¢˜ 3: æŸ¥è¯¢æ€§èƒ½ä¸‹é™**
- åŸå› : ç¼ºå°‘ç´¢å¼•æˆ–æŸ¥è¯¢ä¼˜åŒ–
- è§£å†³: ä½¿ç”¨åŸç”Ÿ SQL å›é€€æˆ–æ·»åŠ ç´¢å¼•

#### ä¼˜åŠ¿æ€»ç»“

âœ… **ç±»å‹å®‰å…¨** - ç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯  
âœ… **è½»é‡çº§** - åªæœ‰ 1.5MBï¼Œæ— æ„å»ºè´Ÿæ‹…  
âœ… **æ˜“å­¦æ˜“ç”¨** - SQL-like è¯­æ³•ï¼Œé›¶å­¦ä¹ æˆæœ¬  
âœ… **å¯ç»´æŠ¤æ€§** - Schema å³æ–‡æ¡£ï¼Œæ¸…æ™°ç›´è§‚  
âœ… **å¯æ‰©å±•æ€§** - æ”¯æŒåŸç”Ÿ SQL å›é€€  
âœ… **ä¸šåŠ¡éš”ç¦»** - Repository å±‚è§£è€¦ä¸šåŠ¡ä¸æ•°æ®åº“  
âœ… **æ¸è¿›å¼è¿ç§»** - å¯ä¸åŸç”Ÿ SQL å…±å­˜  

---

## ğŸ“ å½“å‰æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Solana Blockchain                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Helius Laserstream (gRPC)
                      â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  SolanaBlockScanner  â”‚  ç”Ÿäº§è€…
            â”‚   (å•è¿›ç¨‹)            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ XADD
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Redis Stream        â”‚  æ¶ˆæ¯é˜Ÿåˆ—
            â”‚ block_data_stream    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ XREADGROUP
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ SolanaBlockData      â”‚  æ¶ˆè´¹è€…
            â”‚    Handler           â”‚  (å¤šè¿›ç¨‹)
            â”‚  (Consumer Group)    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ClickHouse    â”‚         â”‚   PostgreSQL    â”‚
â”‚  (äº¤æ˜“æ•°æ®)      â”‚         â”‚   (å…ƒæ•°æ®)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„

```
solana-scan-node-new/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ database/                       # ğŸ†• æ•°æ®åº“å±‚ï¼ˆDrizzle ORMï¼‰
â”‚   â”‚   â”œâ”€â”€ schema/                     # Schema å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ snapshot-info.ts        # å¿«ç…§ä¿¡æ¯è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ token-snapshot.ts       # ä»£å¸å¿«ç…§è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ wallet-trading-snapshot.ts # é’±åŒ…å¿«ç…§è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ token.ts                # ä»£å¸åŸºç¡€ä¿¡æ¯è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ lp-info.ts              # æµåŠ¨æ€§æ± è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ smart-money.ts          # èªæ˜é’±åœ°å€è¡¨
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                # ç»Ÿä¸€å¯¼å‡º
â”‚   â”‚   â”œâ”€â”€ repositories/               # Repository å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ SnapshotInfoRepository.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ TokenSnapshotRepository.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ WalletTradingSnapshotRepository.ts
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ client.ts                   # æ•°æ®åº“å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ index.ts                    # æ•°æ®åº“å±‚ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ scan/
â”‚   â”‚   â”œâ”€â”€ SolanaBlockScanner.ts       # ç”Ÿäº§è€…ï¼šè®¢é˜…åŒºå—æ•°æ®
â”‚   â”‚   â””â”€â”€ BlockDataSerializer.ts      # åºåˆ—åŒ–ä¸ Stream æ“ä½œ
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ SolanaBlockDataHandler.ts   # æ¶ˆè´¹è€…ï¼šå¤„ç†åŒºå—æ•°æ®
â”‚   â”‚   â”œâ”€â”€ TokenPriceService.ts        # ä»£å¸ä»·æ ¼æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ TokenInfoService.ts         # ä»£å¸ä¿¡æ¯æœåŠ¡
â”‚   â”‚   â””â”€â”€ snapshot/                   # å¿«ç…§æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ snapshot.ts             # åŸç”Ÿ SQL ç‰ˆæœ¬
â”‚   â”‚       â”œâ”€â”€ snapshot-new.ts         # ğŸ†• Drizzle ç‰ˆæœ¬
â”‚   â”‚       â”œâ”€â”€ token_ss.ts             # ä»£å¸å¿«ç…§æœåŠ¡
â”‚   â”‚       â””â”€â”€ wallet_trading_ss.ts    # é’±åŒ…å¿«ç…§æœåŠ¡
â”‚   â”œâ”€â”€ collection/
â”‚   â”‚   â””â”€â”€ dex-parser.ts               # DEX è§£æå™¨
â”‚   â”œâ”€â”€ constant/
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â”œâ”€â”€ redis.ts                # Redis å®¢æˆ·ç«¯é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ clickhouse.ts           # ClickHouse é…ç½®
â”‚   â”‚   â””â”€â”€ index.ts                    # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ examples/                       # ğŸ†• ç¤ºä¾‹ä»£ç 
â”‚   â”‚   â””â”€â”€ drizzle-usage.ts            # Drizzle ä½¿ç”¨ç¤ºä¾‹
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ SolanaBlockUtil.ts          # åŒºå—å·¥å…·ç±»
â”‚   â”‚   â””â”€â”€ postgresqlHelper.ts         # PostgreSQL å·¥å…·ï¼ˆä¿ç•™å…¼å®¹ï¼‰
â”‚   â””â”€â”€ __tests__/                      # æµ‹è¯•æ–‡ä»¶
â”‚       â”œâ”€â”€ drizzle.test.ts             # ğŸ†• Drizzle æµ‹è¯•
â”‚       â”œâ”€â”€ snapshot.test.ts            # å¿«ç…§æµ‹è¯•
â”‚       â””â”€â”€ postgre.test.ts             # PostgreSQL æµ‹è¯•
â”œâ”€â”€ drizzle.config.ts                   # ğŸ†• Drizzle é…ç½®
â”œâ”€â”€ AGENT.md                            # Agent å†³ç­–è®°å½•ï¼ˆæœ¬æ–‡æ¡£ï¼‰
â”œâ”€â”€ DRIZZLE_MIGRATION.md                # ğŸ†• Drizzle è¿ç§»æŒ‡å—
â”œâ”€â”€ DEPLOYMENT_GUIDE.md                 # éƒ¨ç½²æŒ‡å—
â”œâ”€â”€ BUGFIX_SUMMARY.md                   # Bug ä¿®å¤è®°å½•
â””â”€â”€ package.json
```

---

## ğŸ§  é‡å¤§å†³ç­–è®°å½•

### å†³ç­– #001: é‡‡ç”¨ Redis Stream æ›¿ä»£ Hash + Lock
- **æ—¥æœŸ**: 2025-11-25
- **å†³ç­–è€…**: Agent + User
- **èƒŒæ™¯**: æ—§æ¶æ„å­˜åœ¨æ­»é”é£é™©ã€èµ„æºæ¶ˆè€—é«˜ã€æ•…éšœæ¢å¤å·®ç­‰é—®é¢˜
- **å†³ç­–**: é‡‡ç”¨ Redis Stream + Consumer Group æ¨¡å¼
- **ç†ç”±**: 
  - æ— é”è®¾è®¡ï¼Œæ¶ˆé™¤æ­»é”
  - åŸç”Ÿæ•…éšœæ¢å¤ï¼ˆXCLAIMï¼‰
  - ä½èµ„æºæ¶ˆè€—ï¼ˆé˜»å¡è¯»å–ï¼‰
  - é«˜å¯è§‚æµ‹æ€§
- **å½±å“**: 
  - éœ€è¦ Redis 5.0+
  - ä»£ç é‡æ„ï¼ˆ3ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼‰
  - éƒ¨ç½²æµç¨‹å˜æ›´
- **çŠ¶æ€**: âœ… å·²å®æ–½

### å†³ç­– #002: é‡‡ç”¨ Drizzle ORM é‡æ„æ•°æ®åº“å±‚
- **æ—¥æœŸ**: 2025-11-25
- **å†³ç­–è€…**: Agent + User
- **èƒŒæ™¯**: 
  - åŸç”Ÿ SQL ç¼ºä¹ç±»å‹å®‰å…¨
  - ä»£ç ç»´æŠ¤å›°éš¾ï¼ŒSQL æ•£è½å„å¤„
  - ç¼ºä¹ç»Ÿä¸€çš„æ•°æ®è®¿é—®å±‚
  - ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®åº“è€¦åˆ
- **å†³ç­–**: é‡‡ç”¨ Drizzle ORM + Repository æ¨¡å¼
- **å¤‡é€‰æ–¹æ¡ˆ**: 
  - Prismaï¼ˆâŒ å¤ªé‡ï¼Œ50MBï¼Œéœ€è¦ä»£ç ç”Ÿæˆï¼‰
  - Kyselyï¼ˆâœ… å¯é€‰ï¼Œä½†ç¼ºå°‘è¿ç§»å·¥å…·ï¼‰
  - Drizzleï¼ˆâœ… æœ€ä½³ï¼Œè½»é‡ã€æ˜“ç”¨ã€ç±»å‹å®‰å…¨ï¼‰
- **ç†ç”±**: 
  - è½»é‡çº§ï¼ˆ1.5MBï¼‰
  - SQL-like è¯­æ³•ï¼Œé›¶å­¦ä¹ æˆæœ¬
  - å®Œæ•´çš„ TypeScript æ”¯æŒ
  - æ— éœ€ä»£ç ç”Ÿæˆæ­¥éª¤
  - æ”¯æŒåŸç”Ÿ SQL å›é€€
  - ä¸ç°æœ‰ ClickHouse/Redis ä»£ç é£æ ¼ä¸€è‡´
- **å½±å“**: 
  - æ–°å¢ `src/database/` ç›®å½•
  - å¯ä¸åŸç”Ÿ SQL å…±å­˜ï¼Œæ¸è¿›å¼è¿ç§»
  - å¼€å‘æ•ˆç‡æå‡ 50%
  - ä»£ç å¯ç»´æŠ¤æ€§å¤§å¹…æå‡
- **è¿ç§»ç­–ç•¥**:
  - é˜¶æ®µ1: æ–°åŠŸèƒ½ä½¿ç”¨ Drizzle
  - é˜¶æ®µ2: è¿ç§»é«˜é¢‘æŸ¥è¯¢æ“ä½œ
  - é˜¶æ®µ3: é€æ­¥æ›¿æ¢æ‰€æœ‰ PostgreSQL æ“ä½œ
  - é˜¶æ®µ4: ç§»é™¤ `postgresqlHelper.ts`
- **çŠ¶æ€**: âœ… å·²å®æ–½ï¼ˆåŸºç¡€æ¶æ„å®Œæˆï¼Œå¾…è¿ç§»ç°æœ‰ä»£ç ï¼‰

---

## ğŸ”® å¾…åŠäº‹é¡¹ä¸è·¯çº¿å›¾

### çŸ­æœŸç›®æ ‡ï¼ˆ1-2å‘¨ï¼‰

- [ ] ç›‘æ§ Redis Stream æ€§èƒ½æŒ‡æ ‡
- [ ] ç¼–å†™è‡ªåŠ¨åŒ–ç›‘æ§è„šæœ¬
- [ ] å‹åŠ›æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿé«˜é¢‘åŒºå—ï¼‰
- [ ] ä¼˜åŒ– Pending æ¶ˆæ¯å¤„ç†ç­–ç•¥
- [ ] æ·»åŠ æ­»ä¿¡é˜Ÿåˆ—ï¼ˆå¤„ç†å¤±è´¥æ¶ˆæ¯ï¼‰
- [ ] ğŸ†• è¿ç§» snapshot æœåŠ¡åˆ° Drizzle Repository
- [ ] ğŸ†• è¿ç§» token_ss æœåŠ¡åˆ° Drizzle Repository
- [ ] ğŸ†• è¿ç§» wallet_trading_ss æœåŠ¡åˆ° Drizzle Repository
- [ ] ğŸ†• æ€§èƒ½æµ‹è¯•å¯¹æ¯”ï¼ˆDrizzle vs åŸç”Ÿ SQLï¼‰

### ä¸­æœŸç›®æ ‡ï¼ˆ1-3ä¸ªæœˆï¼‰

- [ ] å®ç°æ¶ˆæ¯ä¼˜å…ˆçº§ï¼ˆé‡è¦åŒºå—ä¼˜å…ˆå¤„ç†ï¼‰
- [ ] æ·»åŠ åˆ†å¸ƒå¼è¿½è¸ªï¼ˆOpenTelemetryï¼‰
- [ ] ä¼˜åŒ–æ•°æ®åº“å†™å…¥æ€§èƒ½ï¼ˆæ‰¹é‡ upsertï¼‰
- [ ] å®ç°åŒºå—æ•°æ®ç¼“å­˜å±‚
- [ ] æ”¯æŒå¤šé“¾æ‰©å±•ï¼ˆEthereum, BSC ç­‰ï¼‰
- [ ] ğŸ†• å®Œå…¨ç§»é™¤ `postgresqlHelper.ts`
- [ ] ğŸ†• ä¸º Tokenã€LpInfoã€SmartMoney è¡¨åˆ›å»º Repository
- [ ] ğŸ†• ä½¿ç”¨ Drizzle Kit ç®¡ç†æ•°æ®åº“è¿ç§»
- [ ] ğŸ†• å®ç°æ•°æ®åº“äº‹åŠ¡å¤„ç†ï¼ˆDrizzle Transactionï¼‰

### é•¿æœŸç›®æ ‡ï¼ˆ3-6ä¸ªæœˆï¼‰

- [ ] å¾®æœåŠ¡åŒ–æ‹†åˆ†ï¼ˆæ‰«æã€è§£æã€å­˜å‚¨ç‹¬ç«‹æœåŠ¡ï¼‰
- [ ] å®ç°å®æ—¶å‘Šè­¦ç³»ç»Ÿ
- [ ] æ”¯æŒå†å²æ•°æ®å›æº¯
- [ ] å®ç°æ•°æ®å¤‡ä»½ä¸å®¹ç¾
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆç›®æ ‡ï¼š1000 TPSï¼‰

---

## ğŸ“ å˜æ›´æ—¥å¿—

### 2025-11-25

**ä¸Šåˆ - Redis Stream é‡æ„**:
- âœ… å®Œæˆ Redis Stream æ¶æ„é‡æ„
- âœ… åˆ›å»º AGENT.md æ–‡æ¡£
- âœ… æ›´æ–° Redis å®¢æˆ·ç«¯ï¼ˆæ·»åŠ  Stream æ–¹æ³•ï¼‰
- âœ… é‡æ„ç”Ÿäº§è€…é€»è¾‘
- âœ… é‡æ„æ¶ˆè´¹è€…é€»è¾‘
- âœ… æ·»åŠ æ•…éšœæ¢å¤æœºåˆ¶

**ä¸‹åˆ - Drizzle ORM é‡æ„**:
- âœ… å®Œæˆ ORM æ–¹æ¡ˆé€‰å‹ï¼ˆDrizzle vs Prisma vs Kyselyï¼‰
- âœ… å®‰è£… Drizzle ORM ä¾èµ–
- âœ… åˆ›å»ºæ•°æ®åº“ Schema å±‚ï¼ˆ6ä¸ªè¡¨ï¼‰
- âœ… åˆ›å»º Repository å±‚ï¼ˆ3ä¸ªæ ¸å¿ƒ Repositoryï¼‰
- âœ… åˆ›å»ºæ•°æ®åº“å®¢æˆ·ç«¯å’Œè¿æ¥æ± 
- âœ… ç¼–å†™å®Œæ•´æµ‹è¯•ç”¨ä¾‹ï¼ˆdrizzle.test.tsï¼‰
- âœ… ç¼–å†™ä½¿ç”¨ç¤ºä¾‹ï¼ˆdrizzle-usage.tsï¼‰
- âœ… åˆ›å»ºè¿ç§»æŒ‡å—ï¼ˆDRIZZLE_MIGRATION.mdï¼‰
- âœ… é‡å†™ snapshot æœåŠ¡ï¼ˆsnapshot-new.tsï¼‰
- âœ… æ›´æ–° AGENT.md æ–‡æ¡£

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

### ä¸º Agent æä¾›çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

å½“ä½ ä½œä¸º Agent ç»§ç»­å¼€å‘æ­¤é¡¹ç›®æ—¶ï¼Œè¯·æ³¨æ„ï¼š

1. **æ ¸å¿ƒæ¶æ„**: 
   - Redis Stream æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æ ¸å¿ƒï¼Œä¸è¦è½»æ˜“æ›´æ¢
   - Drizzle ORM æ˜¯æ•°æ®åº“è®¿é—®å±‚ï¼Œä¼˜å…ˆä½¿ç”¨ Repository
   
2. **å…³é”®æ–‡ä»¶**: 
   - ç”Ÿäº§è€…: `src/scan/SolanaBlockScanner.ts`
   - æ¶ˆè´¹è€…: `src/service/SolanaBlockDataHandler.ts`
   - åºåˆ—åŒ–: `src/scan/BlockDataSerializer.ts`
   - æ•°æ®åº“å±‚: `src/database/` (ğŸ†• ä½¿ç”¨ Drizzle ORM)
   
3. **æ•°æ®åº“è®¿é—®è§„åˆ™**:
   - âœ… æ–°åŠŸèƒ½: ä½¿ç”¨ `src/database/repositories/`
   - âš ï¸ æ—§ä»£ç : ä½¿ç”¨ `src/utils/postgresqlHelper.ts` (å¾…è¿ç§»)
   - âœ… ClickHouse: ç»§ç»­ä½¿ç”¨åŸç”Ÿå®¢æˆ·ç«¯
   - âœ… Redis: ç»§ç»­ä½¿ç”¨åŸç”Ÿå®¢æˆ·ç«¯
   
4. **ç‰ˆæœ¬è¦æ±‚**:
   - Redis: >= 5.0 (Stream æ”¯æŒ)
   - PostgreSQL: >= 12.0
   - Node.js: >= 18.0
   
5. **æ€§èƒ½ç“¶é¢ˆ**: 
   - å½“å‰ç“¶é¢ˆåœ¨ DEX è§£æå’Œæ•°æ®åº“å†™å…¥
   - ä¸åœ¨æ¶ˆæ¯é˜Ÿåˆ—æœ¬èº«
   - Drizzle ORM æ€§èƒ½ä¸åŸç”Ÿ SQL ç›¸å½“
   
6. **æ‰©å±•ç‚¹**:
   - å¢åŠ æ¶ˆè´¹è€…è¿›ç¨‹æ•°ï¼ˆæ°´å¹³æ‰©å±•ï¼‰
   - ä¼˜åŒ– DEX è§£æå™¨æ€§èƒ½
   - æ‰¹é‡æ•°æ®åº“å†™å…¥ï¼ˆä½¿ç”¨ Repository.batchCreateï¼‰
   - ä¸ºæ›´å¤šè¡¨åˆ›å»º Repository

### ä»£ç è§„èŒƒ

- TypeScript ä¸¥æ ¼æ¨¡å¼
- ä½¿ç”¨ async/awaitï¼ˆé¿å…å›è°ƒåœ°ç‹±ï¼‰
- é”™è¯¯å¤„ç†å¿…é¡»ä½¿ç”¨ try-catch
- æ—¥å¿—ä½¿ç”¨ console.logï¼ˆå¸¦ emoji å‰ç¼€ï¼‰
- Redis æ“ä½œå¤±è´¥è¦æœ‰é™çº§æ–¹æ¡ˆ
- ğŸ†• æ•°æ®åº“æ“ä½œä¼˜å…ˆä½¿ç”¨ Repository å±‚
- ğŸ†• æ–°å»ºè¡¨å¿…é¡»å…ˆå®šä¹‰ Schemaï¼Œç„¶ååˆ›å»º Repository
- ğŸ†• Repository æ–¹æ³•å‘½åè§„èŒƒ:
  - æŸ¥è¯¢: `find*()`, `get*()`
  - åˆ›å»º: `create()`, `batchCreate()`
  - æ›´æ–°: `update()`
  - åˆ é™¤: `delete()`

---

## ğŸ“š å‚è€ƒèµ„æ–™

### æŠ€æœ¯æ–‡æ¡£
- [Redis Stream å®˜æ–¹æ–‡æ¡£](https://redis.io/docs/data-types/streams/)
- [Helius Laserstream](https://docs.helius.dev/laserstream)
- [Yellowstone gRPC](https://github.com/rpcpool/yellowstone-grpc)

### ç›¸å…³æ–‡ä»¶
- `DEPLOYMENT_GUIDE.md` - éƒ¨ç½²æŒ‡å—
- `BUGFIX_SUMMARY.md` - Bug ä¿®å¤è®°å½•
- `DRIZZLE_MIGRATION.md` - ğŸ†• Drizzle ORM è¿ç§»æŒ‡å—
- `src/examples/drizzle-usage.ts` - ğŸ†• Drizzle ä½¿ç”¨ç¤ºä¾‹
- `src/__tests__/README_SNAPSHOT_TEST.md` - å¿«ç…§æµ‹è¯•æ–‡æ¡£
- `src/__tests__/drizzle.test.ts` - ğŸ†• Drizzle æµ‹è¯•ç”¨ä¾‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0.0  
**æœ€åæ›´æ–°**: 2025-11-25  
**ç»´æŠ¤è€…**: Agent + Development Team  
**é‡å¤§å˜æ›´**: 
- v2.0.0: æ–°å¢ Drizzle ORM æ•°æ®åº“å±‚é‡æ„ç« èŠ‚
- v1.0.0: åˆå§‹ç‰ˆæœ¬ï¼ŒåŒ…å« Redis Stream é‡æ„

